<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Business Bot - Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #6366f1; --primary-dark: #4f46e5; --secondary: #10b981;
            --danger: #ef4444; --warning: #f59e0b; --bg: #f1f5f9; --card: #ffffff;
            --text: #1e293b; --text-light: #64748b; --border: #e2e8f0;
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); min-height: 100vh; color: var(--text); }
        .header { background: linear-gradient(135deg, var(--primary) 0%, #8b5cf6 100%); color: white; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .header h1 { font-size: 24px; display: flex; align-items: center; gap: 10px; }
        .header-subtitle { opacity: 0.9; font-size: 14px; margin-top: 5px; }
        .nav-tabs { background: var(--card); display: flex; border-bottom: 1px solid var(--border); overflow-x: auto; }
        .nav-tab { padding: 15px 25px; cursor: pointer; border-bottom: 3px solid transparent; color: var(--text-light); font-weight: 500; transition: all 0.2s; white-space: nowrap; }
        .nav-tab:hover { background: var(--bg); color: var(--primary); }
        .nav-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        .main { padding: 20px; max-width: 1400px; margin: 0 auto; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--card); padding: 25px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stat-card .number { font-size: 36px; font-weight: bold; color: var(--primary); }
        .stat-card .label { color: var(--text-light); margin-top: 5px; }
        .card { background: var(--card); border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .card-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .card-header h2 { font-size: 18px; }
        .card-body { padding: 20px; }
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 500; font-size: 14px; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-success { background: var(--secondary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--border); color: var(--text); }
        .btn-outline:hover { border-color: var(--primary); color: var(--primary); }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 14px; transition: border-color 0.2s; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary); }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .company-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        .company-card { background: var(--card); border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: transform 0.2s, box-shadow 0.2s; }
        .company-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .company-header { padding: 20px; background: linear-gradient(135deg, var(--primary) 0%, #8b5cf6 100%); color: white; }
        .company-header h3 { font-size: 18px; margin-bottom: 5px; }
        .company-type { opacity: 0.9; font-size: 13px; }
        .company-body { padding: 20px; }
        .company-info { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; }
        .company-info p { display: flex; align-items: center; gap: 8px; color: var(--text-light); font-size: 14px; }
        .company-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        .status { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .status.active { background: #d1fae5; color: #065f46; }
        .status.inactive { background: #fee2e2; color: #991b1b; }
        .status.connecting { background: #fef3c7; color: #92400e; }
        .status.pending { background: #fef3c7; color: #92400e; }
        .status.completed { background: #d1fae5; color: #065f46; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: var(--card); border-radius: 12px; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-size: 20px; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-light); }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; }
        .category-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .category-option { padding: 15px; border: 2px solid var(--border); border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .category-option:hover { border-color: var(--primary); }
        .category-option.selected { border-color: var(--primary); background: #eef2ff; }
        .category-option .icon { font-size: 28px; margin-bottom: 8px; }
        .category-option .name { font-weight: 500; font-size: 13px; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); }
        .table th { font-weight: 600; color: var(--text-light); font-size: 13px; text-transform: uppercase; }
        .knowledge-section { margin-bottom: 30px; }
        .knowledge-section h3 { margin-bottom: 15px; color: var(--text); }
        .item-list { display: flex; flex-direction: column; gap: 10px; }
        .item-card { background: var(--bg); padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .item-info h4 { margin-bottom: 5px; }
        .item-info p { color: var(--text-light); font-size: 14px; }
        .item-price { font-weight: 600; color: var(--secondary); }
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-light); }
        .empty-state .icon { font-size: 64px; margin-bottom: 20px; opacity: 0.5; }
        .qr-display { text-align: center; padding: 20px; }
        .qr-display img { max-width: 250px; border: 4px solid var(--border); border-radius: 12px; }
        @media (max-width: 768px) {
            .header { flex-direction: column; text-align: center; gap: 15px; }
            .company-grid { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div>
            <h1>ü§ñ Universal Business Bot</h1>
            <p class="header-subtitle">Tengeneza Bot ya WhatsApp kwa Biashara Yoyote</p>
        </div>
        <button class="btn btn-primary" onclick="openAddModal()">‚ûï Ongeza Biashara</button>
    </header>

    <nav class="nav-tabs">
        <div class="nav-tab active" data-tab="dashboard" onclick="switchTab('dashboard')">üìä Dashboard</div>
        <div class="nav-tab" data-tab="companies" onclick="switchTab('companies')">üè¢ Biashara</div>
        <div class="nav-tab" data-tab="knowledge" onclick="switchTab('knowledge')">üìö Knowledge Base</div>
        <div class="nav-tab" data-tab="orders" onclick="switchTab('orders')">üì¶ Orders</div>
    </nav>

    <main class="main">
        <div class="tab-panel active" id="tab-dashboard">
            <div class="stats-grid">
                <div class="stat-card"><div class="number" id="stat-total">0</div><div class="label">Biashara Zote</div></div>
                <div class="stat-card"><div class="number" id="stat-active">0</div><div class="label">Zinazofanya Kazi</div></div>
                <div class="stat-card"><div class="number" id="stat-orders">0</div><div class="label">Orders/Bookings</div></div>
                <div class="stat-card"><div class="number" id="stat-categories">12</div><div class="label">Aina za Biashara</div></div>
            </div>
            <div class="card">
                <div class="card-header"><h2>üè¢ Biashara Zako</h2><button class="btn btn-primary btn-sm" onclick="openAddModal()">‚ûï Ongeza</button></div>
                <div class="card-body"><div class="company-grid" id="company-list"></div></div>
            </div>
        </div>

        <div class="tab-panel" id="tab-companies">
            <div class="card">
                <div class="card-header"><h2>üè¢ Orodha ya Biashara</h2><button class="btn btn-primary" onclick="openAddModal()">‚ûï Ongeza Biashara Mpya</button></div>
                <div class="card-body"><div class="company-grid" id="company-list-full"></div></div>
            </div>
        </div>

        <div class="tab-panel" id="tab-knowledge">
            <div class="card">
                <div class="card-header"><h2>üìö Knowledge Base</h2></div>
                <div class="card-body">
                    <div class="form-group">
                        <label>Chagua Biashara</label>
                        <select id="knowledge-company" onchange="loadKnowledge()"><option value="">-- Chagua Biashara --</option></select>
                    </div>
                    <div id="knowledge-editor" style="display: none;"></div>
                </div>
            </div>
        </div>

        <div class="tab-panel" id="tab-orders">
            <div class="card">
                <div class="card-header"><h2>üì¶ Orders & Bookings</h2></div>
                <div class="card-body">
                    <table class="table">
                        <thead><tr><th>ID</th><th>Biashara</th><th>Mteja</th><th>Aina</th><th>Status</th><th>Tarehe</th></tr></thead>
                        <tbody id="orders-list"><tr><td colspan="6" class="empty-state">Hakuna orders bado</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <div class="modal" id="add-modal">
        <div class="modal-content">
            <div class="modal-header"><h2>‚ûï Ongeza Biashara Mpya</h2><button class="modal-close" onclick="closeAddModal()">&times;</button></div>
            <div class="modal-body">
                <form id="add-company-form">
                    <div id="step-1">
                        <h3 style="margin-bottom: 15px;">1Ô∏è‚É£ Chagua Aina ya Biashara</h3>
                        <div class="category-grid" id="category-selector"></div>
                    </div>
                    <div id="step-2" style="display: none;">
                        <h3 style="margin-bottom: 15px;">2Ô∏è‚É£ Maelezo ya Biashara</h3>
                        <div class="form-row">
                            <div class="form-group"><label>Jina la Biashara *</label><input type="text" id="company-name" placeholder="Mfano: Mama Ntilie Restaurant" required></div>
                            <div class="form-group"><label>Namba ya WhatsApp (Admin) *</label><input type="text" id="admin-number" placeholder="255688774043" required></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>Jina la Bot</label><input type="text" id="bot-name" placeholder="Mfano: Amina, Salama"></div>
                            <div class="form-group"><label>Mahali</label><input type="text" id="location" placeholder="Mfano: Dar es Salaam"></div>
                        </div>
                        <div class="form-group"><label>Maelezo ya Biashara</label><textarea id="description" rows="3" placeholder="Eleza biashara yako..."></textarea></div>
                        <div class="form-group"><label>Gemini API Key (Si lazima)</label><input type="text" id="gemini-key" placeholder="Acha tupu kutumia default"></div>
                        <input type="hidden" id="selected-category" value="">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeAddModal()">Ghairi</button>
                <button class="btn btn-outline" id="btn-back" style="display: none;" onclick="goToStep1()">‚¨ÖÔ∏è Rudi</button>
                <button class="btn btn-primary" id="btn-next" onclick="goToStep2()">Endelea ‚û°Ô∏è</button>
                <button class="btn btn-success" id="btn-save" style="display: none;" onclick="saveCompany()">üíæ Hifadhi</button>
            </div>
        </div>
    </div>

    <div class="modal" id="qr-modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header"><h2>üì± Scan QR Code</h2><button class="modal-close" onclick="closeQRModal()">&times;</button></div>
            <div class="modal-body qr-display">
                <p id="qr-company-name" style="margin-bottom: 15px; font-weight: 500;"></p>
                <img id="qr-image" src="" alt="QR Code">
                <p style="margin-top: 15px; color: var(--text-light);">Fungua WhatsApp ‚Üí Linked Devices ‚Üí Scan</p>
            </div>
        </div>
    </div>

    <script>
        let companies = [];
        let categories = [
            { value: 'tourism', label: 'üå¥ Utalii' },
            { value: 'hotel', label: 'üè® Hoteli' },
            { value: 'restaurant', label: 'üçΩÔ∏è Mgahawa' },
            { value: 'salon', label: 'üíá Salon' },
            { value: 'retail', label: 'üõí Duka' },
            { value: 'healthcare', label: 'üè• Kliniki' },
            { value: 'fitness', label: 'üí™ Gym' },
            { value: 'education', label: 'üìö Elimu' },
            { value: 'transport', label: 'üöó Usafiri' },
            { value: 'events', label: 'üéâ Matukio' },
            { value: 'services', label: 'üîß Huduma' },
            { value: 'real_estate', label: 'üè† Nyumba' },
            { value: 'other', label: 'üè¢ Nyingine' }
        ];
        let selectedCategory = null;
        let currentKnowledge = null;

        document.addEventListener('DOMContentLoaded', () => {
            renderCategorySelector();
            loadCompanies();
            loadStats();
            loadOrders();
            setInterval(() => { loadCompanies(); loadStats(); }, 10000);
        });

        function switchTab(tabId) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
            if (tabId === 'knowledge') updateKnowledgeDropdown();
        }

        function renderCategorySelector() {
            document.getElementById('category-selector').innerHTML = categories.map(cat => 
                `<div class="category-option" data-value="${cat.value}" onclick="selectCategory('${cat.value}')">
                    <div class="icon">${cat.label.split(' ')[0]}</div>
                    <div class="name">${cat.label.split(' ').slice(1).join(' ')}</div>
                </div>`
            ).join('');
        }

        function selectCategory(value) {
            selectedCategory = value;
            document.querySelectorAll('.category-option').forEach(el => el.classList.remove('selected'));
            document.querySelector(`[data-value="${value}"]`).classList.add('selected');
            document.getElementById('selected-category').value = value;
        }

        async function loadCompanies() {
            try {
                const res = await fetch('/api/companies');
                companies = await res.json();
                renderCompanies();
                updateKnowledgeDropdown();
            } catch (err) { console.error('Failed to load companies:', err); }
        }

        function renderCompanies() {
            const getCatLabel = (type) => (categories.find(c => c.value === type)?.label || 'üè¢ Biashara');
            const html = companies.length === 0 ? 
                '<div class="empty-state"><div class="icon">üè¢</div><h3>Hakuna biashara bado</h3><p>Bonyeza "Ongeza Biashara" kuanza</p></div>' :
                companies.map(c => `
                    <div class="company-card">
                        <div class="company-header"><h3>${c.name}</h3><div class="company-type">${getCatLabel(c.businessType)}</div></div>
                        <div class="company-body">
                            <div class="company-info">
                                <p>üì± Admin: +${c.adminNumber}</p>
                                ${c.phoneNumber ? `<p>ü§ñ Bot: +${c.phoneNumber}</p>` : ''}
                                <p><span class="status ${c.status}">${c.status === 'active' ? 'Inafanya kazi' : c.status === 'connecting' ? 'Inaunganisha...' : 'Haifanyi kazi'}</span></p>
                            </div>
                            <div class="company-actions">
                                ${c.status === 'inactive' ? `<button class="btn btn-success btn-sm" onclick="startBot('${c.id}')">üöÄ Anza Bot</button>` : ''}
                                ${c.qrCode ? `<button class="btn btn-primary btn-sm" onclick="showQR('${c.id}', '${c.name}', '${c.qrCode}')">üì± QR</button>` : ''}
                                <button class="btn btn-outline btn-sm" onclick="openKnowledgeEditor('${c.id}')">üìö</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteCompany('${c.id}')">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            document.getElementById('company-list').innerHTML = html;
            document.getElementById('company-list-full').innerHTML = html;
        }

        async function loadStats() {
            try {
                const res = await fetch('/api/stats');
                const stats = await res.json();
                document.getElementById('stat-total').textContent = stats.total;
                document.getElementById('stat-active').textContent = stats.active;
                const ordersRes = await fetch('/api/orders');
                const orders = await ordersRes.json();
                document.getElementById('stat-orders').textContent = orders.length;
            } catch (err) { console.error('Failed to load stats:', err); }
        }

        function openAddModal() {
            document.getElementById('add-modal').classList.add('active');
            document.getElementById('step-1').style.display = 'block';
            document.getElementById('step-2').style.display = 'none';
            document.getElementById('btn-next').style.display = 'inline-flex';
            document.getElementById('btn-back').style.display = 'none';
            document.getElementById('btn-save').style.display = 'none';
            selectedCategory = null;
            document.querySelectorAll('.category-option').forEach(el => el.classList.remove('selected'));
        }

        function closeAddModal() {
            document.getElementById('add-modal').classList.remove('active');
            document.getElementById('add-company-form').reset();
        }

        function goToStep2() {
            if (!selectedCategory) { alert('Tafadhali chagua aina ya biashara!'); return; }
            document.getElementById('step-1').style.display = 'none';
            document.getElementById('step-2').style.display = 'block';
            document.getElementById('btn-next').style.display = 'none';
            document.getElementById('btn-back').style.display = 'inline-flex';
            document.getElementById('btn-save').style.display = 'inline-flex';
        }

        function goToStep1() {
            document.getElementById('step-1').style.display = 'block';
            document.getElementById('step-2').style.display = 'none';
            document.getElementById('btn-next').style.display = 'inline-flex';
            document.getElementById('btn-back').style.display = 'none';
            document.getElementById('btn-save').style.display = 'none';
        }

        async function saveCompany() {
            const name = document.getElementById('company-name').value.trim();
            const adminNumber = document.getElementById('admin-number').value.trim();
            const botName = document.getElementById('bot-name').value.trim();
            const location = document.getElementById('location').value.trim();
            const description = document.getElementById('description').value.trim();
            const geminiKey = document.getElementById('gemini-key').value.trim();
            if (!name || !adminNumber) { alert('Jaza jina na namba ya WhatsApp!'); return; }
            try {
                const res = await fetch('/api/companies', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, adminNumber, businessType: selectedCategory, geminiApiKey: geminiKey || undefined })
                });
                const result = await res.json();
                if (result.success) {
                    await fetch(`/api/companies/${result.company.id}/knowledge/init`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ businessInfo: { name, description, location, botName: botName || undefined } })
                    });
                    alert('‚úÖ Biashara imeongezwa!');
                    closeAddModal();
                    loadCompanies();
                    loadStats();
                } else { alert('‚ùå Kosa: ' + result.error); }
            } catch (err) { alert('‚ùå Imeshindwa: ' + err.message); }
        }

        async function startBot(id) {
            if (!confirm('Anza bot?')) return;
            try {
                const res = await fetch(`/api/companies/${id}/start`, { method: 'POST' });
                const result = await res.json();
                if (result.success) { alert('‚úÖ Bot imeanza! Subiri QR code.'); loadCompanies(); }
                else { alert('‚ùå Kosa: ' + result.error); }
            } catch (err) { alert('‚ùå Imeshindwa: ' + err.message); }
        }

        function showQR(id, name, qrCode) {
            document.getElementById('qr-company-name').textContent = name;
            document.getElementById('qr-image').src = qrCode;
            document.getElementById('qr-modal').classList.add('active');
        }

        function closeQRModal() { document.getElementById('qr-modal').classList.remove('active'); }

        async function deleteCompany(id) {
            if (!confirm('Futa biashara hii?')) return;
            try {
                const res = await fetch(`/api/companies/${id}`, { method: 'DELETE' });
                const result = await res.json();
                if (result.success) { alert('‚úÖ Imefutwa!'); loadCompanies(); loadStats(); }
                else { alert('‚ùå Kosa: ' + result.error); }
            } catch (err) { alert('‚ùå Imeshindwa: ' + err.message); }
        }

        function updateKnowledgeDropdown() {
            document.getElementById('knowledge-company').innerHTML = '<option value="">-- Chagua Biashara --</option>' +
                companies.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        async function loadKnowledge() {
            const companyId = document.getElementById('knowledge-company').value;
            if (!companyId) { document.getElementById('knowledge-editor').style.display = 'none'; return; }
            try {
                let res = await fetch(`/api/companies/${companyId}/knowledge`);
                if (!res.ok) {
                    const company = companies.find(c => c.id === companyId);
                    await fetch(`/api/companies/${companyId}/knowledge/init`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ businessInfo: { name: company.name } })
                    });
                    res = await fetch(`/api/companies/${companyId}/knowledge`);
                }
                currentKnowledge = await res.json();
                renderKnowledgeEditor();
                document.getElementById('knowledge-editor').style.display = 'block';
            } catch (err) { console.error(err); alert('‚ùå Imeshindwa kupakia knowledge'); }
        }

        function renderKnowledgeEditor() {
            const k = currentKnowledge;
            const type = k.businessType;
            const sectionConfig = {
                tourism: { section: 'tours', label: 'Safari/Tours' },
                hotel: { section: 'rooms', label: 'Vyumba' },
                restaurant: { section: 'menu', label: 'Menu' },
                salon: { section: 'services', label: 'Huduma' },
                retail: { section: 'products', label: 'Bidhaa' },
                healthcare: { section: 'services', label: 'Huduma' },
                fitness: { section: 'programs', label: 'Programu' },
                education: { section: 'courses', label: 'Kozi' },
                transport: { section: 'services', label: 'Huduma' },
                events: { section: 'services', label: 'Huduma' },
                services: { section: 'services', label: 'Huduma' },
                real_estate: { section: 'properties', label: 'Mali' }
            };
            const cfg = sectionConfig[type] || { section: 'services', label: 'Huduma' };
            const items = k[cfg.section] || [];
            
            document.getElementById('knowledge-editor').innerHTML = `
                <div class="knowledge-section">
                    <h3>üè¢ Maelezo ya Biashara</h3>
                    <div class="form-row">
                        <div class="form-group"><label>Jina</label><input type="text" id="kb-name" value="${k.business?.name || ''}" onchange="updateBusiness()"></div>
                        <div class="form-group"><label>Mahali</label><input type="text" id="kb-location" value="${k.business?.location || ''}" onchange="updateBusiness()"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Simu</label><input type="text" id="kb-phone" value="${k.business?.phone || ''}" onchange="updateBusiness()"></div>
                        <div class="form-group"><label>Email</label><input type="text" id="kb-email" value="${k.business?.email || ''}" onchange="updateBusiness()"></div>
                    </div>
                    <div class="form-group"><label>Maelezo</label><textarea id="kb-description" rows="3" onchange="updateBusiness()">${k.business?.description || ''}</textarea></div>
                </div>
                <div class="knowledge-section">
                    <h3>üìã ${cfg.label}</h3>
                    <div class="item-list" id="items-list">
                        ${items.map(item => `
                            <div class="item-card">
                                <div class="item-info">
                                    <h4>${item.name || 'Item'}</h4>
                                    <p>${item.description || ''}</p>
                                    ${item.price ? `<span class="item-price">${k.business?.currency || 'TZS'} ${item.price}</span>` : ''}
                                </div>
                                <button class="btn btn-danger btn-sm" onclick="deleteItem('${cfg.section}', '${item.id}')">üóëÔ∏è</button>
                            </div>
                        `).join('') || '<p style="color: var(--text-light);">Hakuna bado</p>'}
                    </div>
                    <button class="btn btn-outline" style="margin-top: 15px;" onclick="addItem('${cfg.section}', '${cfg.label}')">‚ûï Ongeza ${cfg.label}</button>
                </div>
                <div class="knowledge-section">
                    <h3>ü§ñ AI Settings</h3>
                    <div class="form-row">
                        <div class="form-group"><label>Jina la Bot</label><input type="text" id="kb-botname" value="${k.ai?.botName || ''}" onchange="updateAI()"></div>
                        <div class="form-group"><label>Personality</label><input type="text" id="kb-personality" value="${k.ai?.personality || ''}" onchange="updateAI()"></div>
                    </div>
                    <div class="form-group"><label>Custom Instructions</label><textarea id="kb-instructions" rows="3" onchange="updateAI()">${k.ai?.customInstructions || ''}</textarea></div>
                </div>
                <div class="knowledge-section">
                    <h3>‚ùì FAQs</h3>
                    <div class="item-list">
                        ${(k.faqs || []).map(faq => `
                            <div class="item-card">
                                <div class="item-info"><h4>Q: ${faq.question}</h4><p>A: ${faq.answer}</p></div>
                                <button class="btn btn-danger btn-sm" onclick="deleteFAQ('${faq.id}')">üóëÔ∏è</button>
                            </div>
                        `).join('') || '<p style="color: var(--text-light);">Hakuna FAQs bado</p>'}
                    </div>
                    <button class="btn btn-outline" style="margin-top: 15px;" onclick="addFAQ()">‚ûï Ongeza FAQ</button>
                </div>
            `;
        }

        async function updateBusiness() {
            const id = document.getElementById('knowledge-company').value;
            const data = {
                name: document.getElementById('kb-name').value,
                location: document.getElementById('kb-location').value,
                phone: document.getElementById('kb-phone').value,
                email: document.getElementById('kb-email').value,
                description: document.getElementById('kb-description').value,
                currency: currentKnowledge.business?.currency || 'TZS',
                hours: currentKnowledge.business?.hours || {}
            };
            await fetch(`/api/companies/${id}/knowledge/business`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
        }

        async function updateAI() {
            const id = document.getElementById('knowledge-company').value;
            const data = { botName: document.getElementById('kb-botname').value, personality: document.getElementById('kb-personality').value, customInstructions: document.getElementById('kb-instructions').value };
            await fetch(`/api/companies/${id}/knowledge/ai`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
        }

        async function addItem(section, label) {
            const name = prompt(`Jina la ${label}:`); if (!name) return;
            const desc = prompt('Maelezo:') || '';
            const price = prompt('Bei:') || '';
            const id = document.getElementById('knowledge-company').value;
            await fetch(`/api/companies/${id}/knowledge/${section}/items`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name, description: desc, price: price ? parseFloat(price) : undefined }) });
            loadKnowledge();
        }

        async function deleteItem(section, itemId) {
            if (!confirm('Futa?')) return;
            const id = document.getElementById('knowledge-company').value;
            await fetch(`/api/companies/${id}/knowledge/${section}/items/${itemId}`, { method: 'DELETE' });
            loadKnowledge();
        }

        async function addFAQ() {
            const q = prompt('Swali:'); if (!q) return;
            const a = prompt('Jibu:'); if (!a) return;
            const id = document.getElementById('knowledge-company').value;
            await fetch(`/api/companies/${id}/knowledge/faqs`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ question: q, answer: a }) });
            loadKnowledge();
        }

        async function deleteFAQ(faqId) {
            if (!confirm('Futa FAQ?')) return;
            const id = document.getElementById('knowledge-company').value;
            await fetch(`/api/companies/${id}/knowledge/faqs/items/${faqId}`, { method: 'DELETE' });
            loadKnowledge();
        }

        function openKnowledgeEditor(companyId) {
            switchTab('knowledge');
            document.getElementById('knowledge-company').value = companyId;
            loadKnowledge();
        }

        async function loadOrders() {
            try {
                const res = await fetch('/api/orders');
                const orders = await res.json();
                document.getElementById('orders-list').innerHTML = orders.length === 0 ? '<tr><td colspan="6" class="empty-state">Hakuna orders bado</td></tr>' :
                    orders.map(o => {
                        const c = companies.find(x => x.id === o.companyId);
                        return `<tr><td>#${o.id.slice(-6)}</td><td>${c?.name || 'N/A'}</td><td>${o.customerName || o.phone || 'N/A'}</td><td>${o.type || 'Order'}</td><td><span class="status ${o.status}">${o.status}</span></td><td>${new Date(o.createdAt).toLocaleDateString('sw-TZ')}</td></tr>`;
                    }).join('');
            } catch (err) { console.error(err); }
        }
    </script>
</body>
</html>
